<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body {
      background-color: rgb(206, 206, 206);
      margin: 0;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
  </style>
</head>

<body>
  <button onclick="update_draw('journaux_mag_online')">Les journaux ou magazines d'information imprimés</button>
  <button onclick="update_draw('journaux_mag_papier')">Les journaux ou magazines d'information en ligne</button>
  <button onclick="update_draw('Les_reseaux_sociaux_en_ligne_et_les_applications_de_messagerie')">Les réseaux sociaux en ligne et les applications de messagerie</button>
  <button onclick="update_draw('La_television')">La télévision</button>
  
  <button onclick="update_radar_chart('DE')">Change radar chart</button>

  <svg class='barChart'></svg>

  <script>
    //---------------------------------------- VARIABLES ----------------------------------------
    var nation_to_link = {
      'UE29': "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Flag_of_Europe.svg/1200px-Flag_of_Europe.svg.png",
      'BE': "https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Flag_of_Belgium.svg/1200px-Flag_of_Belgium.svg.png",
      'BG': "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Flag_of_Bulgaria.svg/1200px-Flag_of_Bulgaria.svg.png",
      'CZ': "https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Flag_of_the_Czech_Republic.svg/1200px-Flag_of_the_Czech_Republic.svg.png",
      'DK': "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Flag_of_Denmark.svg/1200px-Flag_of_Denmark.svg.png",
      'DE': "https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/Flag_of_Germany.svg/1200px-Flag_of_Germany.svg.png",
      'EE': "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8f/Flag_of_Estonia.svg/1200px-Flag_of_Estonia.svg.png",
      'IE': "https://upload.wikimedia.org/wikipedia/commons/thumb/4/45/Flag_of_Ireland.svg/1200px-Flag_of_Ireland.svg.png",
      'EL': "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Flag_of_Greece.svg/1200px-Flag_of_Greece.svg.png",
      'ES': "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Flag_of_Spain.svg/1200px-Flag_of_Spain.svg.png",
      'FR': "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/Flag_of_France.svg/1200px-Flag_of_France.svg.png",
      'HR': "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Flag_of_Croatia.svg/1200px-Flag_of_Croatia.svg.png",
      'IT': "https://upload.wikimedia.org/wikipedia/commons/thumb/0/03/Flag_of_Italy.svg/1200px-Flag_of_Italy.svg.png",
      'CY': "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Cyprus.svg/1200px-Flag_of_Cyprus.svg.png",
      'LV': "https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Flag_of_Latvia.svg/1200px-Flag_of_Latvia.svg.png",
      'LT': "https://upload.wikimedia.org/wikipedia/commons/thumb/1/11/Flag_of_Lithuania.svg/1200px-Flag_of_Lithuania.svg.png",
      'LU': "https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/Flag_of_Luxembourg.svg/1200px-Flag_of_Luxembourg.svg.png",
      'HU': "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Flag_of_Hungary.svg/1200px-Flag_of_Hungary.svg.png",
      'MT': "https://upload.wikimedia.org/wikipedia/commons/thumb/7/73/Flag_of_Malta.svg/1200px-Flag_of_Malta.svg.png",
      'NL': "https://upload.wikimedia.org/wikipedia/commons/thumb/2/20/Flag_of_the_Netherlands.svg/1200px-Flag_of_the_Netherlands.svg.png",
      'AT': "https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Flag_of_Austria.svg/1200px-Flag_of_Austria.svg.png",
      'PL': "https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Flag_of_Poland.svg/1200px-Flag_of_Poland.svg.png",
      'PT': "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Flag_of_Portugal.svg/1200px-Flag_of_Portugal.svg.png",
      'RO': "https://upload.wikimedia.org/wikipedia/commons/thumb/7/73/Flag_of_Romania.svg/1200px-Flag_of_Romania.svg.png",
      'SI': "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Flag_of_Slovenia.svg/1200px-Flag_of_Slovenia.svg.png",
      'SK': "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/Flag_of_Slovakia.svg/1200px-Flag_of_Slovakia.svg.png",
      'FI': "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Flag_of_Finland.svg/1200px-Flag_of_Finland.svg.png",
      'UK': "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Flag_of_the_United_Kingdom.svg/1200px-Flag_of_the_United_Kingdom.svg.png",
      'SE': "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/Flag_of_Sweden.svg/1200px-Flag_of_Sweden.svg.png",
    }
    var window_width = 960;
    var window_height = 600;
    var margin = {
      top: 0.05 * window_height,
      right: 0.05 * window_width,
      bottom: 0.05 * window_height,
      left: 0.05 * window_width
    };

    var svg_width = window_width - margin.left - margin.right;
    var svg_height = window_height - margin.top - margin.bottom;

    var bar_chart_width = 0.6 * svg_width;
    var bar_chart_height = svg_height;

    var radar_chart_width = (1 - 0.6) * svg_width;
    var radar_chart_height = svg_height;

    var x_middle_radar_chart = margin.left + bar_chart_width + radar_chart_width / 2;
    var y_middle_radar_chart = margin.top + radar_chart_height / 2;

    //var height = window_height - margin.top - margin.bottom;
    var flag_space = 0.1 * bar_chart_width;
    var flag_margin = 0.2 * flag_space;

    var top_n = 10;

    var rect_height = 0.6 * bar_chart_height / (2 * top_n + 1);

    var answers = ["Totally trust", "Tend to trust", "DKNA", "Tend not to trust", "Do not trust at all"];

    // ---------------------------------------- SCALES ----------------------------------------
    var horizontal_bar_scale = d3.scaleLinear()
      .domain([0, 1])
      .range([margin.left + flag_space, bar_chart_width + margin.left])

    var vertical_scale = d3.scaleLinear()
      .domain([0, top_n * 2 + 2])
      .range([margin.top, bar_chart_height + margin.top])

    var color_scale = d3.scaleLinear().domain([0, 4]).range(['green', 'red']);

    // ---------------------------------------- FUNCTION ----------------------------------------
    function compute_rect_height(data, i_country) {
      var d = data[i_country]
      var data_sorted = data.slice(); // On store une version triée de dataset
      data_sorted.sort(function (d1, d2) { return d2["Total 'Trust'"] - d1["Total 'Trust'"] })
      var sorted_i = data_sorted.indexOf(d);

      if (sorted_i < top_n || sorted_i > 28 - top_n || d["Country"] == "UE29") {// The country is displayed only if this conditions are True
        return rect_height;
      }
      else {
        return 0;
      }
    }

    function i_country_to_vertical_i(data, i_country) {
      var d = data[i_country]
      var data_sorted = data.slice(); // On store une version triée de dataset
      data_sorted.sort(function (d1, d2) { return d2["Total 'Trust'"] - d1["Total 'Trust'"] })
      var sorted_i = data_sorted.indexOf(d);
      if (sorted_i < top_n) {
        return sorted_i;
      }
      else if (sorted_i > 28 - top_n) {
        return sorted_i - (28 - 2 * top_n - 1);
      }
      else if (d["Country"] == "UE29") {
        return top_n + 0.5;
      }
      else {
        return top_n + 0.5;
      }
    }

    // ---------------------------------------- SVG ----------------------------------------
    // Ajout d'un element svg au body
    var svg = d3.select(".barChart")
      .attr("width", window_width)
      .attr("height", window_height)
      .append("g")

    function draw_rect(data) {

      // -------------------BAR CHART------------------------------
      console.log(answers)
      console.log(data)
      var stack = d3.stack().keys(answers);
      stack.value(function (d, key) {
        return +d[key];
      });
      var layers = stack(data);
      console.log(layers)

      // The bars
      svg.selectAll("g")
        .data(layers)
        .enter().append("g")
        .style("fill", function (d, i_ans) { return color_scale(i_ans); })
        .selectAll("rect")
        .data(function (d) { return d })
        .enter().append("rect")
        .attr("x", horizontal_bar_scale(0))
        .attr("y", function (d, i_country) { return vertical_scale(i_country_to_vertical_i(data, i_country)); })
        .attr("width", 0)
        .attr("height", function (d, i_country) { return compute_rect_height(data, i_country); })
        .on("mouseover", function () {
          d3.selectAll('rect').style("fill-opacity", "0.75");
          d3.select(this).style("fill-opacity", "1");
        })
        .on("mouseout", function () {
          d3.selectAll('rect').style("fill-opacity", "1");
        })
        .on("click", function (d, i_country) {
          console.log("à coder")
        })
        ;

      // Animation when the page is loaded
      svg.selectAll("g")
        .data(layers)
        .selectAll("rect")
        .data(function (d) { return d; })
        .transition()
        .duration(2000)
        .attr("width", function (d, i_country) { return horizontal_bar_scale(d[1]) - horizontal_bar_scale(d[0]); })
        .attr("x", function (d) { return horizontal_bar_scale(d[0]); })

      // ------------------------FLAGS-------------------------
      svg.selectAll('flag').data(data).enter()
        .append("svg:image")
        .attr("x", margin.left)
        .attr("y", function (d, i_country) { return vertical_scale(i_country_to_vertical_i(data, i_country)); })
        .attr('width', flag_space - flag_margin)
        .attr("height", function (d, i_country) { return compute_rect_height(data, i_country); })
        .attr("xlink:href", function (d, i_country) { return nation_to_link[d['Country']]; })
    }

    // ---------------------------------------- SHAPES ----------------------------------------
    function draw(media_type) {
      d3.csv('https://raw.githubusercontent.com/quenting44/desinformation/master/data/' + media_type + '.csv', function (data) {
        draw_rect(data)
      })
    }
    draw('journaux_mag_online');

    function update_draw(media_type) {
      d3.csv('https://raw.githubusercontent.com/quenting44/desinformation/quentin/data/' + media_type + '.csv', function (data) {
        console.log(data)
        var stack = d3.stack().keys(answers);
        stack.value(function (d, key) {
          return +d[key];
        });

        var layers = stack(data);

        svg.selectAll("g")
          .data(layers)
          .selectAll("rect")
          .data(function (d) { return d; })
          .transition()
          .duration(600)
          .attr("x", function (d) { return horizontal_bar_scale(d[0]); })
          .attr("y", function (d, i_country) { return vertical_scale(i_country_to_vertical_i(data, i_country)); })
          .attr("width", function (d, i_country) { return horizontal_bar_scale(d[1]) - horizontal_bar_scale(d[0]); })
          .attr("height", function (d, i_country) { return compute_rect_height(data, i_country); })

        svg.selectAll('image').data(data)
          .transition()
          .duration(600)
          .attr("y", function (d, i_country) { return vertical_scale(i_country_to_vertical_i(data, i_country)); })
          .attr("height", function (d, i_country) { return compute_rect_height(data, i_country); })
      })
    }

    // -------------------------RADAR CHART---------------------------
    // Variables
    var nb_features = 7;
    var size = 100;
    var devices = ["Desk Computer", "Laptop", "Mobile Phone", "Landline phone", "Internet connection at home", "Tablet", "At least one device"]


    // Draw the baselines
    for (var i = 0; i < nb_features; i++) {
      svg.append('line')
        .attr("x1", x_middle_radar_chart)
        .attr("y1", y_middle_radar_chart)
        .attr("x2", x_middle_radar_chart + size * Math.cos(2 * i * Math.PI / nb_features - Math.PI / 2))
        .attr("y2", y_middle_radar_chart + size * Math.sin(2 * i * Math.PI / nb_features - Math.PI / 2))
        .style("stroke", "black")
        .style("stroke-width", "2px");
    }

    // Function
    function point_on_radar(i, x) {
      return [
        x_middle_radar_chart + size * x * Math.cos(2 * i * Math.PI / nb_features - Math.PI / 2),
        y_middle_radar_chart + size * x * Math.sin(2 * i * Math.PI / nb_features - Math.PI / 2)
      ]
    }

    d3.csv('https://raw.githubusercontent.com/quenting44/desinformation/quentin/data/data_devices.csv', function (data) {
      var my_data = data.filter(function (d) {
        return d["Country"] == "FR" && d["Media"] == "Les journaux ou magazines d'information en ligne" && d["Answer"] == "Tend to trust";
      })[0]

      var data = devices.map(function (device, i) { return { 'val': +my_data[device] }; })

      svg.selectAll("polygon")
        .data([data])
        .enter()
        .append("polygon")
        .attr("points", function (da) {
          return da.map(function (d, i) {
            return point_on_radar(i, d.val).join(",")
          }).join(' ')
        })
        .attr("stroke", "red")
        .attr('fill', 'red')
        .attr('fill-opacity', '0.3')
        .attr("stroke-width", 1);
    })

    function update_radar_chart(country, media, answer) {
      d3.csv('https://raw.githubusercontent.com/quenting44/desinformation/quentin/data/data_devices.csv', function (data) {
        var my_data = data.filter(function (d) {
          return d["Country"] == country && d["Media"] == media && d["Answer"] == answer;
        })[0]

        var data = devices.map(function (device, i) { return { 'val': +my_data[device] }; })

        svg.selectAll("polygon")
          .data([data])
          .attr("points", function (da) {
            return da.map(function (d, i) {
              return point_on_radar(i, d.val).join(",")
            }).join(' ')
          });


      })
    }

  </script>
</body>