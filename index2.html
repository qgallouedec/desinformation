<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body {
      background-color: rgb(206, 206, 206);
      margin: 0;
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
  </style>
</head>

<body>
  <button onclick="choose('journaux_mag_online')">Les journaux ou magazines d'information imprimés</button>
  <button onclick="choose('journaux_mag_papier')">Les journaux ou magazines d'information en ligne</button>

  <script>
    var nation_to_link = {
      'UE29': "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b7/Flag_of_Europe.svg/1200px-Flag_of_Europe.svg.png",
      'BE': "https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/Flag_of_Belgium.svg/1200px-Flag_of_Belgium.svg.png",
      'BG': "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Flag_of_Bulgaria.svg/1200px-Flag_of_Bulgaria.svg.png",
      'CZ': "https://upload.wikimedia.org/wikipedia/commons/thumb/c/cb/Flag_of_the_Czech_Republic.svg/1200px-Flag_of_the_Czech_Republic.svg.png",
      'DK': "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9c/Flag_of_Denmark.svg/1200px-Flag_of_Denmark.svg.png",
      'DE': "https://upload.wikimedia.org/wikipedia/commons/thumb/b/ba/Flag_of_Germany.svg/1200px-Flag_of_Germany.svg.png",
      'EE': "https://upload.wikimedia.org/wikipedia/commons/thumb/8/8f/Flag_of_Estonia.svg/1200px-Flag_of_Estonia.svg.png",
      'IE': "https://upload.wikimedia.org/wikipedia/commons/thumb/4/45/Flag_of_Ireland.svg/1200px-Flag_of_Ireland.svg.png",
      'EL': "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Flag_of_Greece.svg/1200px-Flag_of_Greece.svg.png",
      'ES': "https://upload.wikimedia.org/wikipedia/commons/thumb/9/9a/Flag_of_Spain.svg/1200px-Flag_of_Spain.svg.png",
      'FR': "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/Flag_of_France.svg/1200px-Flag_of_France.svg.png",
      'HR': "https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Flag_of_Croatia.svg/1200px-Flag_of_Croatia.svg.png",
      'IT': "https://upload.wikimedia.org/wikipedia/commons/thumb/0/03/Flag_of_Italy.svg/1200px-Flag_of_Italy.svg.png",
      'CY': "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d4/Flag_of_Cyprus.svg/1200px-Flag_of_Cyprus.svg.png",
      'LV': "https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Flag_of_Latvia.svg/1200px-Flag_of_Latvia.svg.png",
      'LT': "https://upload.wikimedia.org/wikipedia/commons/thumb/1/11/Flag_of_Lithuania.svg/1200px-Flag_of_Lithuania.svg.png",
      'LU': "https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/Flag_of_Luxembourg.svg/1200px-Flag_of_Luxembourg.svg.png",
      'HU': "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Flag_of_Hungary.svg/1200px-Flag_of_Hungary.svg.png",
      'MT': "https://upload.wikimedia.org/wikipedia/commons/thumb/7/73/Flag_of_Malta.svg/1200px-Flag_of_Malta.svg.png",
      'NL': "https://upload.wikimedia.org/wikipedia/commons/thumb/2/20/Flag_of_the_Netherlands.svg/1200px-Flag_of_the_Netherlands.svg.png",
      'AT': "https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/Flag_of_Austria.svg/1200px-Flag_of_Austria.svg.png",
      'PL': "https://upload.wikimedia.org/wikipedia/commons/thumb/1/12/Flag_of_Poland.svg/1200px-Flag_of_Poland.svg.png",
      'PT': "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Flag_of_Portugal.svg/1200px-Flag_of_Portugal.svg.png",
      'RO': "https://upload.wikimedia.org/wikipedia/commons/thumb/7/73/Flag_of_Romania.svg/1200px-Flag_of_Romania.svg.png",
      'SI': "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Flag_of_Slovenia.svg/1200px-Flag_of_Slovenia.svg.png",
      'SK': "https://upload.wikimedia.org/wikipedia/commons/thumb/e/e6/Flag_of_Slovakia.svg/1200px-Flag_of_Slovakia.svg.png",
      'FI': "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bc/Flag_of_Finland.svg/1200px-Flag_of_Finland.svg.png",
      'UK': "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Flag_of_the_United_Kingdom.svg/1200px-Flag_of_the_United_Kingdom.svg.png",
      'SE': "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4c/Flag_of_Sweden.svg/1200px-Flag_of_Sweden.svg.png",
    }

    var margin = { top: 40, right: 20, bottom: 30, left: 20 };

    // Largeur et hauteur
    var window_width = 960,
      window_height = 700;


    // Largeur et longueur du corps du svg
    var width = window_width - margin.left - margin.right,
      height = window_height - margin.top - margin.bottom;

    var flag_space = 40;
    var top_n = 3;

    // Ajout d'un element svg au body
    var svg = d3.select("body").append("svg")
      .attr("width", window_width)
      .attr("height", window_height)


    // Ouverture du fichier
    //https://raw.githubusercontent.com/quenting44/desinformation/master/data/journaux_mag_papier.csv
    d3.csv('https://raw.githubusercontent.com/quenting44/desinformation/master/data/journaux_mag_online.csv', function (data) {

      data_sorted = data.slice(); // On store une version triée de dataset
      data_sorted.sort(function (d1, d2) { return d2["Total 'Trust'"] - d1["Total 'Trust'"] })

      // Les fonctions de mapping
      var vertical_scale = d3.scaleLinear()
        .domain([0, data.length])
        .range([margin.top, height + margin.top])

      var horizontal_bar_scale = d3.scaleLinear()
        .domain([0, 1])
        .range([0, width - flag_space])

      var rect_height = height / (data.length + 5);

      var color_scale = d3.scaleLinear().domain([0, 4]).range(['green', 'red']);

      // Les réponses possibles
      var answers = ["Totally trust", "Tend to trust", "DKNA", "Tend not to trust", "Do not trust at all"];

      // Les pourcentages cumulé jusqu'à la réponse i_ans
      function cumul_percent(d, i_ans) {
        var x = 0
        for (var ii_ans = 0; ii_ans < i_ans; ii_ans++) {
          x = x + d[answers[ii_ans]] * 1;
        }
        return x;
      }

      // Nouvel index en fonction de la liste triée
      function new_i(d, i_ans) {
        return data_sorted.indexOf(d);
      }

      function hidden_or_not(d, i_country) {
        var sorted_i = new_i(d, i_country);

        if (sorted_i < top_n || sorted_i > 28 - top_n || d["Country"] == "UE29") {
          return rect_height;
        }
        return 0;
      }


      function find_a_name(d, i_country) {
        var sorted_i = new_i(d, i_country);
        if (sorted_i < top_n) {
          return sorted_i;
        }
        if (sorted_i > 28 - top_n) {
          return sorted_i - (28 - 2 * top_n - 1);
        }
        return top_n + 0.5;
      }

      for (var i_ans = 0; i_ans < answers.length; i_ans++) {
        svg.selectAll(answers[i_ans]).data(data).enter()
          .append("rect")
          .attr("x", function (d, i_country) { return margin.left + flag_space + horizontal_bar_scale(cumul_percent(d, i_ans)); })
          .attr("y", function (d, i_country) { return vertical_scale(find_a_name(d, i_country)); })
          .attr("width", function (d, i_country) { return horizontal_bar_scale(d[answers[i_ans]]); })
          .attr("height", hidden_or_not)
          .style("fill", color_scale(i_ans)) // Pour enlever le remplissage
          .style("stroke", "none") // Pour les contours noirs
          .transition()
          .delay(1000)
      }

      svg.selectAll('flag').data(data).enter()
        .append("svg:image")
        .attr("x", margin.left)
        .attr("y", function (d, i_country) { return vertical_scale(find_a_name(d, i_country)); })
        .attr('width', 24)
        .attr('height', hidden_or_not)
        .attr("xlink:href", function (d, i_country) { return nation_to_link[d['Country']]; })
    })

    function choose(media_type) {
      setInterval(function (d) {
        svg.selectAll("rect").data(data).transition()
          .attr("height", function (d) { return y(d); })
          .attr("y", function (d) { return 200 - y(d); })

      }, 500);

    }
    //choose('journaux_mag_online')
  </script>
</body>